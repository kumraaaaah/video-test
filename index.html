<!doctype html>
<html>
<head>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
    
    <style>
        /* Style for the HTML buttons and text overlay */
        .ar-ui-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            pointer-events: none; /* Let touches pass through the container */
            display: none; /* Initially hidden */
            font-family: Arial, Helvetica, sans-serif;
            color: white;
        }

        .ar-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.6);
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            pointer-events: auto; /* Buttons are clickable */
            cursor: pointer;
        }

        #prev-button-html { left: 15px; }
        #next-button-html { right: 15px; }

        .instructions-text {
            position: absolute;
            bottom: 30px;
            width: 100%;
            text-align: center;
            font-size: 16px;
            text-shadow: 0 0 8px black;
        }
    </style>
    
    <script>
        AFRAME.registerComponent('ar-video-player', {
            init: function () {
                // --- SETUP ---
                this.videoSources = [
                    'assets/@KRSNAOfficial - No Cap (Live Performance Video)_2.mp4',
                    'assets/ezgif-512a1a0aa7266c.mp4'
                ];
                this.currentIndex = 0;
                
                this.marker = this.el.sceneEl.querySelector("a-marker");
                this.videoAsset = this.el.sceneEl.querySelector("#vid");
                this.videoEntity = this.el.querySelector("#ar-video");
                this.target = this.videoEntity.object3D;
                
                // --- NEW: Get HTML UI elements ---
                this.uiOverlay = document.querySelector("#ui-overlay");
                this.nextButton = document.querySelector("#next-button-html");
                this.prevButton = document.querySelector("#prev-button-html");

                // --- Manipulation setup ---
                this.touchState = { isOneFingerRotating: false, isTwoFingerManipulating: false, startDist: 0, startAngle: 0, startScale: new THREE.Vector3(), startRotation: new THREE.Euler(), lastPanPos: { x: 0, y: 0 }, lastRotatePos: { x: 0, y: 0 }, touchStartTime: 0, startTouchPos: { x: 0, y: 0 } };
                this.handleTouchStart = this.handleTouchStart.bind(this);
                this.handleTouchMove = this.handleTouchMove.bind(this);
                this.handleTouchEnd = this.handleTouchEnd.bind(this);

                // --- ADD EVENT LISTENERS ---
                this.marker.addEventListener('markerFound', this.onMarkerFound.bind(this));
                this.nextButton.addEventListener('click', this.onNext.bind(this));
                this.prevButton.addEventListener('click', this.onPrev.bind(this));
                this.videoEntity.addEventListener('touchstart', this.handleTouchStart); // For manipulation

                // Set initial video
                this.videoAsset.setAttribute('src', this.videoSources[this.currentIndex]);
            },

            onMarkerFound: function () {
                this.el.setAttribute('visible', 'true');
                this.uiOverlay.style.display = 'block'; // Show the HTML UI
                this.videoAsset.play();
            },
            
            onNext: function () { this.currentIndex = (this.currentIndex + 1) % this.videoSources.length; this.loadVideo(); },
            onPrev: function () { this.currentIndex = (this.currentIndex - 1 + this.videoSources.length) % this.videoSources.length; this.loadVideo(); },
            loadVideo: function () { this.videoAsset.setAttribute('src', this.videoSources[this.currentIndex]); this.videoAsset.load(); this.videoAsset.play(); },

            handleTouchStart: function(e){this.el.sceneEl.addEventListener("touchmove",this.handleTouchMove);this.el.sceneEl.addEventListener("touchend",this.handleTouchEnd);const t=e.detail.event.touches;1===t.length?(this.touchState.isOneFingerRotating=!0,this.touchState.lastRotatePos={x:t[0].clientX,y:t[0].clientY},this.touchState.touchStartTime=e.timeStamp,this.touchState.startTouchPos={x:t[0].clientX,y:t[0].clientY}):2===t.length&&(this.touchState.isTwoFingerManipulating=!0,s=t[0],a=t[1],i=s.clientX-a.clientX,n=s.clientY-a.clientY,this.touchState.startDist=Math.sqrt(i*i+n*n),this.touchState.startAngle=Math.atan2(n,i),this.touchState.startScale.copy(this.target.scale),this.touchState.startRotation.copy(this.target.rotation),this.touchState.lastPanPos={x:(s.clientX+a.clientX)/2,y:(s.clientY+a.clientY)/2})},
            handleTouchMove: function(e){const t=e.touches;if(this.touchState.isOneFingerRotating&&1===t.length){const s={x:t[0].clientX,y:t[0].clientY},a=s.x-this.touchState.lastRotatePos.x,i=s.y-this.touchState.lastRotatePos.y;this.target.rotation.y+=.01*a,this.target.rotation.x+=.01*i,this.touchState.lastRotatePos=s}if(this.touchState.isTwoFingerManipulating&&2===t.length){s=t[0],a=t[1],i=s.clientX-a.clientX,n=a.clientY-s.clientY;const e={x:(s.clientX+a.clientX)/2,y:(s.clientY+a.clientY)/2},o=e.x-this.touchState.lastPanPos.x,h=e.y-this.touchState.lastPanPos.y;this.touchState.lastPanPos=e,this.target.position.x+=.005*o,this.target.position.y+=.005*h;const r=Math.sqrt(i*i+n*n),l=r/this.touchState.startDist;this.target.scale.copy(this.touchState.startScale).multiplyScalar(l);const c=Math.atan2(n,i),d=c-this.touchState.startAngle;this.target.rotation.z=this.touchState.startRotation.z-d}},
            handleTouchEnd: function(e){this.el.sceneEl.removeEventListener("touchmove",this.handleTouchMove),this.el.sceneEl.removeEventListener("touchend",this.handleTouchEnd),this.touchState.isOneFingerRotating&&(t=e.changedTouches[0],s=e.timeStamp-this.touchState.touchStartTime,a=t.clientX-this.touchState.startTouchPos.x,i=t.clientY-this.touchState.startTouchPos.y,n=Math.sqrt(a*a+i*i),s<200&&n<10&&(this.videoAsset.muted=!this.videoAsset.muted)),this.touchState.isOneFingerRotating=!1,this.touchState.isTwoFingerManipulating=!1}
        });
    </script>
</head>

<body style="margin: 0; overflow: hidden;">

    <div id="ui-overlay" class="ar-ui-overlay">
        <div id="prev-button-html" class="ar-button">&lt;</div>
        <div id="next-button-html" class="ar-button">&gt;</div>
        <div class="instructions-text">Swipe ON video to view NEXT</div>
    </div>

    <a-scene vr-mode-ui="enabled: false" loading-screen="enabled: false;"
        arjs='sourceType: webcam; trackingMethod: best; debugUIEnabled: false;' 
        id="scene" embedded>
        <a-assets>
            <video id="vid" preload="auto" response-type="arraybuffer" loop crossorigin webkit-playsinline muted playsinline></video>
        </a-assets>

        <a-marker type="pattern" preset="custom" url="assets/marker.patt"></a-marker>
        
        <a-entity camera raycaster="objects: #ar-video;">
            
            <a-entity id="ar-player" ar-video-player visible="false">
                <a-video id="ar-video" src="#vid" scale="0.8 0.8 0.8" position="0 0 -2" rotation="0 0 0"></a-video>
            </a-entity>

        </a-entity>
    </a-scene>
</body>
</html>
